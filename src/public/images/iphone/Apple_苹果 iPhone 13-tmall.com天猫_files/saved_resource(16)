KISSY.add("malldetail/sku/cspu",function(e,t,a,i,n,o,r,l){var s;return{"init":function(e){codeTrack("sku.cspu.init","trade.main.init");var t=this;t.utilMethods(),t.ellast=e.ellast,t.skuMap=e.skuMap,t.spuId=e.spuId,t.cspuCategorySwitch=e.cspuCategorySwitch,t.apiUrl=e.apiUrl,s=new o,t.hasCspu(function(e){t.createEl()})},"hasCspu":function(t){var a=this,i=function(){a.skuMap;var t=new Array(0);for(var i in a.skuMap)a.skuMap[i]&&a.skuMap[i].cspuId&&!e.inArray(a.skuMap[i].cspuId,t)&&t.push(a.skuMap[i].cspuId);return t.length};1==function(){return new r(location.href).getQuery().get("standard")}()&&a.cspuCategorySwitch&&new n({"url":a.apiUrl,"type":"get","data":{"cspuNums":i(),"spuId":a.spuId},"dataType":"jsonp","complete":function(a){a&&a.hasCspu&&(e.isFunction(t)&&t(a),s.set("cspuControl",a))},"timeout":5})},"createEl":function(){var i=this,n=t.parent(i.ellast,".tb-prop");t.css(n,{"position":"relative"}),t.append(t.create('<div id="J_sellerCspu"></div>',{"html":'<span>\u6ca1\u6709\u60f3\u8981\u7684\u89c4\u683c\u5417\uff1f<a class="tm-getall-cspu">\u67e5\u770b\u6240\u6709\u89c4\u683c</a> </span>'}),n),i.el=t.get("#J_sellerCspu"),function(){e.use("mui/overlay/dialog",function(e,t){i.overLayDialog=new t({"skin":"red","showCat":!1,"mask":!1,"headerContent":"","bodyContent":"\u6211\u662f\u5185\u5bb9","align":{"points":["cc","cc"]},"id":"J_sellerCspuDialog","closeAction":"hide"})});var n=function(){i.propElms=t.query(".tb-prop",t.get("#"+i.overLayDialog.get("id"))),i.confirmEl=t.get(".tm-confirm-box","#"+i.overLayDialog.get("id")),i.selectBoxEl=t.get(".tm-cspuselect-box","#"+i.overLayDialog.get("id"));var n=function(){var a=!0;return e.each(i.propElms,function(e,i){t.get(".tb-selected",e)||(a=!1)}),a};e.each(i.propElms,function(o){var r=t.query("li",o);a.on(r,"click",function(a){var o=t.create("<i>\u5df2\u9009\u4e2d</i>"),r="li"==a.target.nodeName?a.target:t.parent(a.target,"li");if(!t.hasClass(r,"tb-out-of-stock")){var l=function(a){var i=e.clone(s.get("cspuSkuProp"));i||(i={});var n=t.attr(r,"data-value"),o=n.split(":"),l={};l[o[0]]=o[1],e.mix(i,l),s.set("cspuSkuProp",i),s.set("currentSelectProp",l),s.set("selectStr",n),s.set("cancelTag",a)};t.hasClass(r,"tb-selected")?(t.removeClass(this.propValEls,"tb-selected"),t.remove(t.get("i",this.propValEls)),s.onChange("cancelSkuMapStock",function(t){if(t){for(var a=e.clone(s.get("cspuSkuMapStock")),i=Object.keys(t),n=0;n<i.length;n++)for(var o=t[n],r=0;r<o.length;r++)o[r]||(a[n][r]=!0);s.set("cancelTag",!1),s.set("cspuSkuMapStock",a)}}),l(!0)):(l(!1),t.removeClass(this.propValEls,"tb-selected"),t.remove(t.get("i",this.propValEls)),t.addClass(r,"tb-selected"),t.append(o,r)),n()?(t.css(i.confirmEl,"display","block"),t.css(i.selectBoxEl,"display","none")):(t.css(i.confirmEl,"display","none"),t.css(i.selectBoxEl,"display","block"))}},{"propValEls":r})}),s.onChange("cspuSkuProp",function(e){}),s.onChange("cspuSkuMapStock",function(e){for(var a=Object.keys(e),n=t.create("<i>\u5df2\u9009\u4e2d</i>"),o=0;o<a.length;o++)for(var r=t.query("li",i.propElms[o]),l=e[o],s=0;s<l.length;s++)if(l[s])t.removeClass(r[s],"tb-out-of-stock");else if(t.addClass(r[s],"tb-out-of-stock"),t.hasClass(r[s],"tb-selected"))if(t.removeClass(r[s],"tb-selected"),t.remove(t.get("i",r[s])),r.length>s+1)t.addClass(r[s+1],"tb-selected"),t.append(n,r[s+1]);else for(var c=0;c<r.length;c++)if(!t.hasClass(r[c],"tb-out-of-stock")){t.addClass(r[c],"tb-selected"),t.append(n,r[c]);break}})},o=function(){var n=t.get("span",t.get(".tm-confirm-box","#"+i.overLayDialog.get("id")));a.on(n,"click",function(a){s.onLoad(["cspuMap"],function(a){var n=t.query(".tb-selected",i.propElms),o="";e.each(n,function(e,a){o+=t.attr(e,"data-value")+";"});var r=a[o.substring(0,o.length-1)].itemId;r&&(i.overLayDialog&&i.overLayDialog.hide(),l.openNewSafeTab("//detail.tmall.com/item.htm?standard=1&cspuGuider=1&id="+r))})})},r=!1;a.on(t.get(".tm-getall-cspu",i.el),"click tap",function(e){i.renderProsElm(),i.overLayDialog.render(),i.overLayDialog.show(),TShop.sendAtpanel("tmalldetail.38.1"),r||(n(),o(),r=!0)})}()},"renderProsElm":function(){var e=this;s.onLoad(["cspuPropList"],function(t){var a=i({"cspuPropList":t});e.overLayDialog.set("bodyContent",a)})},"utilMethods":function(){Object.keys||(Object.keys=function(e){var t=[];for(var a in e)e.hasOwnProperty(a)&&t.push(a);return t})}}},{"requires":["dom","event","malldetail/sku/cspu.tpl","io","detail-model/cspu","uri","malldetail/common/util","malldetail/sku/cspu.css"]});KISSY.add("malldetail/sku/cspu.tpl",function(){return function(e,t){var a={"escapehash":{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#x27;","/":"&#x2f;"},"escapereplace":function(e){return a.escapehash[e]},"escaping":function(e){return"string"!=typeof e?e:e.replace(/[&<>"]/gim,this.escapereplace)},"detection":function(e){return void 0===e?"":e}},s=function(e){if("undefined"!=typeof console){if(console.warn)return void console.warn(e);if(console.log)return void console.log(e)}throw e};t=t||{},t.__escapehtml=a,t.__throw=s;var e=e||{},i="";i+="";try{i+="";var c=e.cspuPropList;e.item,e.iv,e.index,e.dl,e.prop,e.clear,e.dt,e.metatit,e.dd,e.ul,e.property,e.img,e.li,e.value,e.a,e.center,e.repeat,e.span,e.i,e.div,e.cspuselect,e.box,e.confirm;i+="",function(){for(var e in c)if(c.hasOwnProperty(e)){var a=c[e];i+=' <dl class="tb-prop tm-clear">     <dt class="tb-metatit">',i+=t.__escapehtml.escaping(t.__escapehtml.detection(a.name)),i+="</dt>     <dd>         ",a.isImg?(i+='         <ul data-property="',i+=t.__escapehtml.escaping(t.__escapehtml.detection(a.name)),i+='" class="tm-clear J_TCspuProp  tb-img">             ',function(){for(var e in a.value)if(a.value.hasOwnProperty(e)){var s=a.value[e],c=e;i+='             <li data-value="',i+=t.__escapehtml.escaping(t.__escapehtml.detection(a.pid)),i+=":",i+=t.__escapehtml.escaping(t.__escapehtml.detection(s.vid)),i+='" title="',i+=t.__escapehtml.escaping(t.__escapehtml.detection(s.title)),i+='">                 <a style="background:url(',i+=t.__escapehtml.escaping(t.__escapehtml.detection(s.url)),i+='_30x30q90.jpg) center no-repeat;">                     <span>',i+=t.__escapehtml.escaping(t.__escapehtml.detection(s.title)),i+="</span>                 </a>                 ",0==c&&(i+="<i>\u5df2\u9009\u4e2d</i>"),i+="             </li>             "}}(),i+="         </ul>         "):(i+='         <ul data-property="',i+=t.__escapehtml.escaping(t.__escapehtml.detection(a.name)),i+='" class="tm-clear J_TCspuProp  ">             ',function(){for(var e in a.value)if(a.value.hasOwnProperty(e)){var s=a.value[e],c=e;i+='             <li data-value="',i+=t.__escapehtml.escaping(t.__escapehtml.detection(a.pid)),i+=":",i+=t.__escapehtml.escaping(t.__escapehtml.detection(s.vid)),i+='">                 <a>                     <span>',i+=t.__escapehtml.escaping(t.__escapehtml.detection(s.name)),i+="</span>                 </a>                 ",0==c&&(i+="<i>\u5df2\u9009\u4e2d</i>"),i+="             </li>             "}}(),i+="         </ul>         "),i+="     </dd> </dl> "}}(),i+=' <div class="tm-cspuselect-box">     <span>\u8bf7\u9009\u62e9\u4f60\u8981\u7684\u89c4\u683c</span> </div> <div class="tm-confirm-box">     <span>\u786e\u5b9a</span> </div>  '}catch(n){t.__throw("Juicer Render Exception: "+n.message)}return i+=""}});KISSY.add("detail-model/cspu",function(t,e,o){function n(t){n.superclass.constructor.apply(this,arguments);var e=this;codeTrack("model.cspu.init","app.init"),e.addAttr("testdata",{"load":function(t){e.onLoad("cspuControl",function(e){e&&e.testdata&&t(e.testdata)})}}),e.addAttr("cspuPropList",{"load":function(t){e.onLoad("cspuControl",function(e){e&&e.cspuPropList&&t(e.cspuPropList)})}}),e.addAttr("cspuMap",{"load":function(t){e.onLoad("cspuControl",function(e){e&&e.cspuMap&&t(e.cspuMap)})}}),e.addAttr("cspuSkuProp",{"load":function(t){e.onLoad("cspuPropList",function(e){if(e){for(var o={},n=0;n<e.length;n++)o[e[n].pid]=null;t(o)}})}}),e.addAttr("currentSelectProp",{"load":function(t){t(null)}}),e.addAttr("cspuSkuMapStock",{"load":function(t){e.onChange(["cspuSkuProp","cspuMap","cspuPropList","currentSelectProp","selectStr","cancelTag"],function(o,n,a,i,c,r){if(o&&i){for(var u={},d=c,m=c.split(":")[0],s=0;s<a.length;s++){for(var l=a[s].value,f=new Array(l.length),p=function(t,e){var o=!1;for(var a in n){var i=new RegExp(e),c=new RegExp(t);i.test(a)&&c.test(a)&&(o=!0)}return o},b=function(t){var e=!1;for(var o in n){new RegExp(t).test(o)&&(e=!0)}return e},h=0;h<f.length;h++){var v=a[s].pid+":"+a[s].value[h].vid;a[s].pid==m?f[h]=b(v):f[h]=p(v,d)}u[s]=f}r?e.set("cancelSkuMapStock",u):t(u)}})}}),e.addAttr("cancelSkuMapStock",{"load":function(t){e.onChange(["cspuSkuMapStock","cancelTag"],function(t,e){})}})}return t.extend(n,e),n},{"requires":["detail-model/model","dom"]});